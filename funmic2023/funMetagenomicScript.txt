####### metagenomic script #######

## first, quick review of command line, and talk about text editors

## (pwd, ls, cd, ssh, etc)

## we actually started yesterday with our nanopore assembly
## the code for me was:

## get into the right conda environment
conda activate flye

## make a directory for our new assembly:
mkdir -p /vol/danBot/assemblies/zymoMC/nanopore/

## or you could make a folder here:
cd /vol/danBot/
mkdir zymoNanoporeAssembly

## set my variables

reads=/vol/danBot/datasets/zymoMC/nanopore/ERR7287988_shortened.fastq
outdir=/vol/danBot/assemblies/zymoMC/nanopore/

## (or your output directory might look like this, depends on what you did above):
## outdir=/vol/danBot/zymoNanoporeAssembly

## run it, using nohup to make sure it doesn't die when we hang up the connection
nohup flye --meta \
    --threads 25 \
    --out-dir $outdir \
    --nano-hq $reads &

## this is the same as:
nohup flye --meta --threads 25 --out-dir $outdir --nano-hq $reads &

## that is our nanopore assembly

## but let's back up and look at the raw data

#### quality check on reads #### 

## let's use fastqc to get a general idea of the 
## quality of our reads

## we will have three files to look at: 1 nanopore, and 2 paired-end illumina files

## nanopore will take the longest, so let's start it first,
## and give it a lot of cores

## zymoMC nanopore fastqc

## activate conda environment:
conda activate readQC

## make our output directory:
mkdir /vol/danBot/zymoQualityChecks/

## set variables
file="/vol/danBot/datasets/zymoMC/nanopore/ERR7287988_shortened.fastq"
outdir="/vol/danBot/zymoQualityChecks/"

## run the command. Use lots of cores, but save some (10) for illumina readsets
fastqc -t 22 -o  $outdir $file 

## that will run for a while! check on it once and while with top
## so try starting another window for repeating with illumina data. 

## activate conda environment:
conda activate readQC

## set variables, let's start with our R1 reads
file="/vol/danBot/datasets/zymoMC/illumina/ERR7255689_1.fastq"
outdir="/vol/danBot/zymoQualityChecks/"

## run the command, with fewer threads than nanopore
fastqc -t 5 -o  $outdir $file 


## and when the R1 reads are complete, run the R2 reads
file="/vol/danBot/datasets/zymoMC/illumina/ERR7255689_2.fastq"
outdir="/vol/danBot/zymoQualityChecks/"
fastqc -t 5 -o  $outdir $file 

## can you find the outputs from this? 

## get these files with SCP. You can grab the whole output directory at once
## this requires using the "-r" flag with scp, from your local computer


## I will put my files here, on my local computer
cd readQC/zymoQC 
## this may be different for you!

fileOnVM="/vol/danBot/zymoQualityChecks"
mySSHkey="/home/daniel/.ssh/funmic2023"
scp -r -i $mySSHkey -P 30500 ubuntu@129.70.51.6:$fileOnVM .

## put them in your /mnt/c/putFilesHere or whatever you called it
## so that windows can see it

## look at these together ##

#### start metaphlan ####

## activate conda
conda deactivate ## only if we are in another environment besides base
conda activate metaphlan

## make your output directory
mkdir /vol/danBot/zymoMCcommunityProfile
cd /vol/danBot/zymoMCcommunityProfile

## set your variables
metaphlanMarkerDB=/vol/danBot/metaphlanDB
seq1=/vol/danBot/datasets/zymoMC/illumina/ERR7255689_1.fastq
seq2=/vol/danBot/datasets/zymoMC/illumina/ERR7255689_2.fastq

nohup metaphlan $seq1,$seq2 \
    --bowtie2db $metaphlanMarkerDB \
    --bowtie2out metaphlanBowtie2.zymoIllu.bz2 \
    --nproc 12 \
    --input_type fastq \
    -o MetaPhlanProfiled_zymoIllu.txt &



#### illumina assembly ####

## activate conda
conda deactivate ## only if we are in another environment besides base
conda activate megahit

## make our output directory. megahit wants to make the last directory itself
mkdir -p /vol/danBot/assemblies/zymoMC/

## set our variables
seq1=/vol/danBot/datasets/zymoMC/illumina/ERR7255689_1.fastq
seq2=/vol/danBot/datasets/zymoMC/illumina/ERR7255689_2.fastq
outdir=/vol/danBot/assemblies/zymoMC/megahitZymoIllumina

## run the actual command
megahit -1 $seq1 \
        -2 $seq2 \
        -t 17 \
        -o $outdir 


#### metaquast evaluation of assemblies ####


### metaquast nanopore assembly ###

### metaquast illumina assembly ###
