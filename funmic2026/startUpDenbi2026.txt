######## set up VM ##########

## let's begin the process of setting up de.NBI for our practical:

## let's get the log-in working

ssh -i /path/to/your/ssh/private/key ubuntu@129.70.51.6 -p 31993

## need to update keys for denbi....

## let's make a new key pair for our "new" desktop

ssh-keygen -t rsa -f officeComp_denbi26

## starting a new repo:
git clone https://github.com/danchurch/FunctionalMicrobiomePractical.git
git config --global user.email "danchurchthomas@gmail.com"
git config --global user.name "danchurch"
git remote set-url origin git@github.com:danchurch/FunctionalMicrobiomePractical.git

 
ssh ubuntu@129.70.51.6 -p 31993 ## login works from desktop. We're in business. 

## if we want to transfer with rsync, instead of scp, any problems there?
## https://stackoverflow.com/questions/4549945/is-it-possible-to-specify-a-different-ssh-port-when-using-rsync
## something like?: rsync -auv daniel@132.180.112.24:/home/daniel/.ssh/officeComp_denbi26.pub ~/

## let's just try rerun our installation scripts from last year:

## mount the drive, with fstab so it survives reboots:

sudo mount /dev/vdc /vol/funmic

blkid /dev/vda 

## funny, volume is not listed as mounted, but seems to be working 
## and rebooting doesn't really break it.  I don't understand.
## but I guess if it isn't broken, don't fix it....

## on the simpleVM de.NBI site, they mention the volumes may not
## be formatted. Let's check.

df -Th ## not listed there. I'm confused. How am I allowed to write to it?

## something doesn't smell right.
## let's try formatting the file system before we do any work. 
## Might save us problems later:

#sudo mkfs.ext4 /dev/vdc
sudo mount /dev/vdc /vol/funmic ## now this works 

lsblk -o NAME,SIZE,MOUNTPOINT,FSTYPE,TYPE,UUID | egrep -v "^loop"

## works. UUID = 1c547cd8-ce37-4efc-a49e-be6d967a72fa

## but change the owner for this path away from Root to normal user:
sudo chown ubuntu:ubuntu /vol/funmic

## let's wait to add it to the fstab. I think this could cost
## problems when we clone the whole setup. 

## some housekeeping software...

sudo apt install unzip

## last year we had do some extra installs for port-forwarding
## do we need to do this again?

## not run ##
apt search xorg

apt search xauth

sudo apt-get install xauth xorg
## not run ^^ ##

## of course, need conda:

mkdir -p /vol/funmic/miniconda

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /vol/funmic/miniconda/miniconda.sh
bash /vol/funmic/miniconda/miniconda.sh -b -u -p /vol/funmic/miniconda/miniconda3
rm /vol/funmic/miniconda/miniconda.sh
source /vol/funmic/miniconda/miniconda3/bin/activate
export PATH=/vol/funmic/miniconda3/miniconda3/bin:$PATH
conda init

## get the main channels that we use:
conda config --add channels defaults
conda config --add channels bioconda
conda config --add channels conda-forge



## now start building the software environments...
## logging in and out, conda is stable. 
## but of course reboot kills it, because of the fstab issue. 
## for now remount and restart conda each time,

## I think that means each time we reboot we need to do this:
sudo mount /dev/vdc /vol/funmic
conda init
source ~/.bashrc

## fix the fstabs individually when we have the other VMs. 

######## science software installs  ##########

####### sra toolkit #######
wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-ubuntu64.tar.gz
tar -xzf sratoolkit.current-ubuntu64.tar.gz

cd /home/ubuntu/sratoolkit.3.3.0-ubuntu64/bin

## set the working directory and temp file location to somewhere on the volume, then
## seems to work, add to path

## adding this to bashrc
export PATH=/home/ubuntu/sratoolkit.3.3.0-ubuntu64/bin:$PATH

####### Dimitri's data #######

## from last year we have this script for getting his 
## data. Does it work?

####### getKelpReads.sh ############

names=(
"ERR3801502"
"ERR3801542"
"ERR3801603"
)

for i in ${names[@]}; do
  prefetch $i
  fasterq-dump --split-files $i
done

####################################

## run this on the volume where we have plenty of room:

mkdir -p /vol/funmic/datasets/kelpBiofilm

cd /vol/funmic/datasets/kelpBiofilm

nohup bash getKelpReads.sh &


