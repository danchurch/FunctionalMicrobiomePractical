## no microtraits this year, drop it. We may use "s-cyc-db" 
## which should just be a diamond-searchable db

######## set up VM ##########

## let's begin the process of setting up de.NBI for our practical:

## let's get the log-in working

ssh -i /path/to/your/ssh/private/key ubuntu@129.70.51.6 -p 31993

## need to update keys for denbi....

## let's make a new key pair for our "new" desktop

ssh-keygen -t rsa -f officeComp_denbi26

## starting a new repo:
git clone https://github.com/danchurch/FunctionalMicrobiomePractical.git
git config --global user.email "danchurchthomas@gmail.com"
git config --global user.name "danchurch"
git remote set-url origin git@github.com:danchurch/FunctionalMicrobiomePractical.git

 
ssh ubuntu@129.70.51.6 -p 31993 ## login works from desktop. We're in business. 

## if we want to transfer with rsync, instead of scp, any problems there?
## https://stackoverflow.com/questions/4549945/is-it-possible-to-specify-a-different-ssh-port-when-using-rsync
## something like?: rsync -auv daniel@132.180.112.24:/home/daniel/.ssh/officeComp_denbi26.pub ~/

## let's just try rerun our installation scripts from last year:

## mount the drive, with fstab so it survives reboots:

sudo mount /dev/vdc /vol/funmic

blkid /dev/vda 

## funny, volume is not listed as mounted, but seems to be working 
## and rebooting doesn't really break it.  I don't understand.
## but I guess if it isn't broken, don't fix it....

## on the simpleVM de.NBI site, they mention the volumes may not
## be formatted. Let's check.

df -Th ## not listed there. I'm confused. How am I allowed to write to it?

## something doesn't smell right.
## let's try formatting the file system before we do any work. 
## Might save us problems later:

#sudo mkfs.ext4 /dev/vdc
sudo mount /dev/vdc /vol/funmic ## now this works 

lsblk -o NAME,SIZE,MOUNTPOINT,FSTYPE,TYPE,UUID | egrep -v "^loop"

## works. UUID = 1c547cd8-ce37-4efc-a49e-be6d967a72fa

## but change the owner for this path away from Root to normal user:
sudo chown ubuntu:ubuntu /vol/funmic

## let's wait to add it to the fstab. I think this could cause
## problems when we clone the whole setup. 

## some housekeeping software...

sudo apt install unzip

## last year we had do some extra installs for port-forwarding
## do we need to do this again?

## not run ##
apt search xorg

apt search xauth

sudo apt-get install xauth xorg
## not run ^^ ##

## of course, need conda:

mkdir -p /vol/funmic/miniconda

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /vol/funmic/miniconda/miniconda.sh
bash /vol/funmic/miniconda/miniconda.sh -b -u -p /vol/funmic/miniconda/miniconda3
rm /vol/funmic/miniconda/miniconda.sh
source /vol/funmic/miniconda/miniconda3/bin/activate
export PATH=/vol/funmic/miniconda3/miniconda3/bin:$PATH
conda init

## get the main channels that we use:
conda config --add channels defaults
conda config --add channels bioconda
conda config --add channels conda-forge



## now start building the software environments...
## logging in and out, conda is stable. 
## but of course reboot kills it, because of the fstab issue. 
## for now remount and restart conda each time,

## I think that means each time we reboot we need to do this:

sudo mount /dev/vdc /vol/funmic
#conda init ## needed?
source ~/.bashrc

## fix the fstabs individually when we have the other VMs. 


####### sra toolkit #######
wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-ubuntu64.tar.gz
tar -xzf sratoolkit.current-ubuntu64.tar.gz

cd /home/ubuntu/sratoolkit.3.3.0-ubuntu64/bin

## set the working directory and temp file location to somewhere on the volume, then
## seems to work, add to path

## adding this to bashrc
export PATH=/home/ubuntu/sratoolkit.3.3.0-ubuntu64/bin:$PATH

####### Dimitri's data #######

## from last year we have this script for getting his 
## data. Does it work?

####### getKelpReads.sh ############

names=(
"ERR3801502"
"ERR3801542"
"ERR3801603"
)

for i in ${names[@]}; do
  prefetch $i
  fasterq-dump --split-files $i
done

####################################

## run this on the volume where we have plenty of room:

mkdir -p /vol/funmic/datasets/kelpBiofilm

cd /vol/funmic/datasets/kelpBiofilm

nohup bash getKelpReads.sh &


######## science software installs  ##########

### cutadapt ###

conda create -n qualityControlRawSequences -c bioconda cutadapt fastqc

### phyloflash ###

conda create -n communityComposition -c bioconda phyloflash

##  formatted silva database for phyloFlash
## looks like they have updated from last year to silva 138.2:

cd /vol/funmic/databases

wget https://zenodo.org/records/18158647/files/138.2.tar.gz

tar -xzf 138.2.tar.gz

mv 138.2/ phyloflashSilvaDB/

### megahit ###
conda create -n assembly -c bioconda megahit

### quast ###
conda create -n assemblyQC -c bioconda quast

### minimap ###

## the repo for minimap (https://github.com/lh3/minimap2?tab=readme-ov-file#install)
## says just download binaries. so:

mkdir /vol/funmic/.minimap2

cd /vol/funmic/.minimap2

curl -L https://github.com/lh3/minimap2/releases/download/v2.28/minimap2-2.28_x64-linux.tar.bz2 | tar -jxvf -

## link to somewhere we can find it
sudo ln -s /vol/funmic/.minimap2/minimap2-2.28_x64-linux/minimap2 /usr/local/bin/minimap2

cd /vol/funmic

wget https://netix.dl.sourceforge.net/project/bbmap/BBMap_39.62.tar.gz

tar -xvzf BBMap_39.62.tar.gz

mv bbmap /vol/funmic/.bbmap/

## needs java:

sudo apt install default-jre

##### binning software #####

## last year installing maxbin2 and concoct via conda worked
## but had to compile metabat from source.

### maxbin2 ###
### concoct ###
conda create -n binning -c bioconda maxbin2 concoct

### metabat ###

## have to install from source (https://bitbucket.org/berkeleylab/metabat/src/master/)

apt search libboost-all-dev
sudo apt install libboost-all-dev
sudo apt install cmake
sudo apt install g++ ## already installed 
apt search autoconf ## already installed 

cd /vol/funmic
git clone https://bitbucket.org/berkeleylab/metabat.git metabat
cd metabat
mkdir build 
cd build
cmake -DCMAKE_INSTALL_PREFIX=/vol/funmic/.metabat ..
make
make install
cd ..
rm -rf build

## add to path 
export PATH="/vol/funmic/.metabat/bin:$PATH"

##### refining bins #####
### das_tool ###

conda config --add channels defaults
conda config --add channels bioconda
conda config --add channels conda-forge
conda create -n refine -c bioconda das_tool

##### depreplication #####
### deprep ###

conda create -n dereplication -c bioconda  drep

##### assign taxonomy to bins #####
### gtdb-tk ###

conda create -n assignTaxonomy -c conda-forge -c bioconda gtdbtk=2.6.1


conda activate assignTaxonomy

## try their script for downloading the GTDB:

download-db.sh

## they say to move this here:
/vol/funmic/miniconda/miniconda3/envs/assignTaxonomy/share/assignTaxonomy/db/

gtdbtk check_install

## while that is running...

##### metabarcoding #####

### R ####
sudo apt install r-base-core

sudo R

## of course some dependencies, variously in R and terminal
install.packages("BiocManager", repos = "https://cloud.r-project.org")

## from last year we were missing the following packages/libraries
sudo apt install libcurl4-openssl-dev
sudo apt install libssl-dev
sudo apt install libblas-dev liblapack-dev
sudo apt install libpng-dev
sudo apt install libjpeg-dev
sudo apt install liblzma-dev
sudo apt install libbz2-dev

BiocManager::install("dada2")

## get a dada2-compatible silva:

cd /vol/funmic/databases

wget https://zenodo.org/records/14169026/files/silva_nr99_v138.2_toGenus_trainset.fa.gz

### vegan ###
install.packages('vegan')

### phyloseq ###
BiocManager::install("phyloseq")

##### annotation software #####

## as before, try one big environment:

conda create -n annotation -c bioconda -c conda-forge prodigal diamond eggnog-mapper interproscan

## I'm confused a bit, not sure if the databases downloaded with that?

emapper.py ## nope


## try their script for getting the database:

download_eggnog_data.py

## it wants a directory at: 
cd /vol/funmic/miniconda/miniconda3/envs/annotation/lib/python3.11/site-packages/data
## which doesn't exist. Not sure if I should make it.

## last year I changed the shell variable for this environment to force it to check 
## some where else. Try this again:

conda activate annotation; echo $CONDA_PREFIX

cd $CONDA_PREFIX

mkdir -p ./etc/conda/activate.d
mkdir -p ./etc/conda/deactivate.d
mkdir /vol/funmic/databases/eggnog-mapper-data

touch ./etc/conda/activate.d/env_vars.sh
touch ./etc/conda/deactivate.d/env_vars.sh

vim ./etc/conda/activate.d/env_vars.sh ## to say:

#############
#!/bin/sh

export EGGNOG_DATA_DIR=/vol/funmic/databases/EggNOG
###############

## and the deactivation script:
vim ./etc/conda/deactivate.d/env_vars.sh

##############
#!/bin/sh

unset EGGNOG_DATA_DIR
##############

## try again:
download_eggnog_data.py

## not finding the embl website...why?

vim -M /vol/funmic/miniconda/miniconda3/envs/annotation/bin/download_eggnog_data.py

download_eggnog_data.py

## from this script...
http://eggnogdb.embl.de/download/emapperdb-{__DB_VERSION__}

vim -M /vol/funmic/miniconda/miniconda3/envs/annotation/lib/python3.11/site-packages/eggnogmapper/version.py ## we need db version 5.0.2


## yeah, the website for the eggnog mapper databases is down and apparently has
## been for a couple months. I have added my name to the list of users on the issue.

## let's try the version that Dimitri has locally on the nanopore computer:

## on my desktop:
rsync -auv test@132.180.112.115:/media/vol2/Databases/EggNOG /media/vol/denbiFileTransfers/

## and then onto deNBI. 

rsync -auv \
  --progress \
  -e "ssh -p 31993" \
  /media/vol/denbiFileTransfers/EggNOG ubuntu@129.70.51.6:/vol/funmic/databases/

## test again:
emapper.py 

## no error about databases. Test it deeper later. 
